<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Suomalaiset merikartat</title>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.15.1/css/ol.css" type="text/css">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script src="http://openlayers.org/en/v3.15.1/build/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.15.1/ol.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.6/proj4.js"></script>
  </head>
  <body>
    
    <div id="license" class="warning">Tämän sivun kartat ovat <a href="http://www.liikennevirasto.fi/avoindata/kayttoehdot/merikartoitusaineiston-lisenssi">Liikenneviraston merikartoitusaineiston lisenssin</a> alaisia. Karttoja ei ole tarkoitettu navigointitarkoituksiin. Karttojen ajantasaisuutta ei taata, ja kartoista saattaa puuttua elementtejä tai ne saattavat olla piirtyneinä virheellisesti. <a href="javascript:" onClick="document.getElementById('license').innerHTML='';">[OK – sulje]</a></div>
    
    <div id="map" class="map"></div>

    <div id="selite" class="textbox">
    </div>

    <script>

var modeDrawing = false;
var drawInteraction; 
var modifyInteraction;
var selectInteraction;
var features = new ol.Collection();


var lvAttributionText = '&copy; Liikennevirasto. Aineistolisenssi Liikenneviraston <a href="http://www.liikennevirasto.fi/avoindata/kayttoehdot/merikartoitusaineiston-lisenssi">sivuilla</a>.';
// EPSG 3067 definition, ETRS-TM35FIN
proj4.defs("EPSG:3067","+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");

var projection = new ol.proj.Projection({
  code: 'EPSG:3067',
  extent: [50199.4814, 6582464.0358, 761274.6247, 7799839.8902]
});

var extent = [150000,6650000,720000,6885000]

var layers = [
  new ol.layer.Tile({
    extent: extent,
    projection: projection,
    source: new ol.source.TileWMS({
      url: 'http://meri.kaislaniemi.net:8080/service',
      crossOrigin: 'anonymous',
      attributions: lvAttributionText,
      params: {
        'LAYERS': 'merikartta_s025',
        'FORMAT': 'image/png'
      },
      serverType: 'geoserver',
      //serverType: /** @type {ol.source.wms.ServerType} */ ('mapserver')
    }),
    minResolution: 5,
    maxResolution: 15,
  }),
  new ol.layer.Tile({
    extent: extent,
    projection: projection,
    source: new ol.source.TileWMS({
      url: 'http://meri.kaislaniemi.net:8080/service',
      crossOrigin: 'anonymous',
      attributions: lvAttributionText,
      params: {
        'LAYERS': 'merikartta_s050',
        'FORMAT': 'image/png'
      },
      serverType: 'geoserver',
      //serverType: /** @type {ol.source.wms.ServerType} */ ('mapserver')
    }),
    minResolution: 15,
    maxResolution: 25,
  }),
  new ol.layer.Tile({
    extent: extent,
    projection: projection,
    source: new ol.source.TileWMS({
      url: 'http://meri.kaislaniemi.net:8080/service',
      crossOrigin: 'anonymous',
      attributions: lvAttributionText,
      params: {
        'LAYERS': 'merikartta_s100',
        'FORMAT': 'image/png'
      },
      serverType: 'geoserver',
    }),
    minResolution: 35,
    maxResolution: 45,
  })
  
];

var ctrlScaleLine = new ol.control.ScaleLine({
  minWidth: 100,
  target: map,
  units: 'metric'
});

var ctrlAttribution = new ol.control.Attribution({
  target: map
});

var ctrlMousePosition = new ol.control.MousePosition({
  target: map,
  projection: 'EPSG:4326',
  coordinateFormat: function(c) { 
    var latdeg, latmin, londeg, lonmin, coordStr;
    latdeg = Math.floor(c[1]);
    latmin = ((c[1] - latdeg)*60.0).toFixed(2);
    londeg = Math.floor(c[0]);
    lonmin = ((c[0] - londeg)*60.0).toFixed(2);

    if (latmin < 10) { latmin = "0" + latmin; }
    else { latmin = "" + latmin; }
    if (lonmin < 10) { lonmin = "0" + lonmin; }
    else { lonmin = "" + lonmin; }

    coordStr = "" + latdeg + "&deg;" + latmin + "' N, " + londeg + "&deg;" + lonmin + " E";
    return coordStr;
  },
  className: 'ol-mouse-position-cust'
});

var ctrlZoom = new ol.control.Zoom({
  duration: 0,
  target: map
});

var SwitchControl = function(opt_options) {
  var options = opt_options || {};

  var button = document.createElement('button');
  button.innerHTML = options.label;
  button.title = (options.title || "");
  
  var this_ = this;
  var handleButton = function() {
    options.switchval = options.switchval ? false : true;
    if (options.switchval) {
      this.style.color = "red";
      (options.enableaction)(this_);
    } else {
      this.style.color = "white";
      (options.disableaction)(this_);
    }
  };

  button.addEventListener('click', handleButton, false);

  var element = document.createElement('div');
  element.className = 'ol-unselectable ol-control ' + options.classname;
  element.appendChild(button);

  ol.control.Control.call(this, {
    element: element,
    target: options.target
  });
};
ol.inherits(SwitchControl, ol.control.Control);

var featureOverlay = new ol.layer.Vector({
  source: new ol.source.Vector({features: features}),
  style: new ol.style.Style({
    fill: new ol.style.Fill({
      color: 'rgba(255, 255, 255, 0.2)'
    }),
    stroke: new ol.style.Stroke({
      color: '#f63',
      width: 2
    }),
    image: new ol.style.Circle({
      radius: 7,
      fill: new ol.style.Fill({
	color: '#f63'
      })
    })
  })
});

var modifyInteraction = new ol.interaction.Modify({
  features: features,
  // the SHIFT key must be pressed to delete vertices, so
  // that new vertices can be drawn at the same position
  // of existing vertices
  deleteCondition: function(event) {
    return ol.events.condition.shiftKeyOnly(event) &&
	ol.events.condition.singleClick(event);
  }
});

var drawingControlOptions = {
  target: map,
  switchval: false,
  label: 'M',
  classname: 'ol-button-choosedraw',
  title: "Make markings",
  enableaction: function(c) { 
    drawInteraction = new ol.interaction.Draw({
      features: features,
      type: /** @type {ol.geom.GeometryType} */ ("MultiLineString")
    });
    modifyInteraction = new ol.interaction.Modify({
      features: features,
      deleteCondition: function(event) {
        return ol.events.condition.shiftKeyOnly(event) &&
          ol.events.condition.singleClick(event);
      }
    });
    c.getMap().addInteraction(drawInteraction);
    c.getMap().addInteraction(modifyInteraction);
  },
  disableaction: function(c) {
    c.getMap().removeInteraction(drawInteraction);
    c.getMap().removeInteraction(modifyInteraction);
  }
};
var ctrlChooseDrawing = new SwitchControl(drawingControlOptions);

var selectControlOptions = {
  target: map,
  switchval: false,
  label: 'S',
  classname: 'ol-button-chooseselect',
  title: "Select markings",
  enableaction: function (c) {
    selectInteraction = new ol.interaction.Select();
    c.getMap().addInteraction(selectInteraction);
  },
  disableaction: function (c) {
    c.getMap().removeInteraction(selectInteraction);
  }
};
var ctrlChooseSelect = new SwitchControl(selectControlOptions);

var map = new ol.Map({
  //controls: ol.control.defaults().extend([
  //  new ol.control.ScaleLine()
  //]),
  layers: layers,
  target: 'map',
  view: new ol.View({
    projection: projection,
    center: [396403,6672892],
    extent: extent,
    resolutions: [40, 20, 10],
    zoom: 7,
    maxZoom: 9,
    minZoom: 7
  }),
  controls: [ ctrlScaleLine, ctrlAttribution, 
    ctrlMousePosition, ctrlZoom, ctrlChooseDrawing,
    ctrlChooseSelect ]
});

featureOverlay.setMap(map);

    </script>
  </body>
</html>
